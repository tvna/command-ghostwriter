---
name: Test & Build

on:
  push:
    branches:
      - develop
    paths-ignore:
      - .devcontainer/**
      - assets/**
      - README.md
      - .gitignore
      - .cz_config.js
      - .pre-commit-config.yaml
      - "**.code-workspace"
  pull_request:
    branches:
      - main
      - develop

defaults:
  run:
    shell: bash

env:
  python-version: 3.12.3
  node-version: 22

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  actionlint:
    name: Lint github actions workflows
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Check workflow files
        uses: docker://rhysd/actionlint:latest
        with:
          args: -color
      - name: Run Typos
        uses: crate-ci/typos@master

  test:
    name: Test web app
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - ubuntu-22.04
          - ubuntu-20.04
        python-version:
          - 3.12.3
          - 3.11
        browser:
          - chromium
          - firefox
          - webkit
        exclude:
          # UbuntuとWebkit、Chromiumの組み合わせを除外
          - os: ubuntu-latest
            browser: webkit
          - os: ubuntu-22.04
            browser: webkit
          - os: ubuntu-20.04
            browser: webkit
          - os: ubuntu-latest
            browser: chromium
          - os: ubuntu-22.04
            browser: chromium
          - os: ubuntu-20.04
            browser: chromium
          # WindowsとWebkitの組み合わせを除外
          - os: windows-latest
            browser: webkit
        include:
          # Windowsのみタイムアウト時間を15分に設定（Webkitは除外）
          - os: windows-latest
            python-version: 3.12.3
            browser: chromium
            timeout-minutes: 15
          - os: windows-latest
            python-version: 3.11
            browser: chromium
            timeout-minutes: 15
          - os: windows-latest
            python-version: 3.12.3
            browser: firefox
            timeout-minutes: 15
          - os: windows-latest
            python-version: 3.11
            browser: firefox
            timeout-minutes: 15
          # 最も一般的な環境を優先的にテスト
          - os: macos-latest
            python-version: 3.12.3
            browser: chromium
            priority: high
      max-parallel: 10
    runs-on: ${{ matrix.os }}
    needs:
      - actionlint
    permissions:
      contents: read
    timeout-minutes: ${{ matrix.timeout-minutes || 10 }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Restore cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
            %LOCALAPPDATA%\pypoetry\Cache
            %USERPROFILE%\.cache\pypoetry
          key: ${{ runner.os }}-python${{ matrix.python-version }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python${{ matrix.python-version }}-poetry
      - name: Bootstrap poetry (Windows)
        if: runner.os == 'Windows'
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
      - name: Bootstrap poetry (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          curl -sL https://install.python-poetry.org | python - -y
        shell: bash
      - name: Update PATH (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        shell: bash
      - name: Configure poetry (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          poetry config virtualenvs.in-project false
        shell: bash
      - name: Install dependencies
        shell: bash
        run: |
          poetry install --no-interaction --no-root --only main,dev
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
            ~/Library/Caches/ms-playwright
            %USERPROFILE%\AppData\Local\ms-playwright
          key: ${{ runner.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/poetry.lock') }}
      # リンターとテストを分離して並列実行
      - name: Lint
        if: ${{ !cancelled() }}
        run: |
          poetry run ruff check .
          poetry run mypy .
      - name: Install Playwright Browser
        run: |
          poetry run playwright install --with-deps ${{ matrix.browser }}
      - name: Unit Tests
        if: ${{ matrix.browser == 'chromium' }}
        run: |
          # 通常のテスト実行（カバレッジ有、ベンチマークなし）
          poetry run pytest --cov=app.py --cov=features --cov=i18n --cov=scripts --cov-report=xml --cov-report=term -n 2 --dist loadfile --durations=10 --cache-clear --maxfail=5 --verbose -k "not e2e"
      - name: E2E Tests (not chromium)
        if: |
          matrix.browser != 'chromium'
        run: |
          # E2Eテスト実行（指定されたブラウザのみ）
          poetry run pytest tests/e2e/ -vv --browser=${{ matrix.browser }} -k "not benchmark"
      - name: E2E Tests with benchmark (Chromium only)
        if: |
          matrix.browser == 'chromium'
        run: |
          # E2Eテストのベンチマーク実行（Chromiumのみ）
          poetry run pytest tests/e2e/ -vv -m "benchmark" --browser=${{ matrix.browser }} --benchmark-only --benchmark-save=github-actions-${{ matrix.browser }} --benchmark-columns=min,max,mean,stddev,median,ops --benchmark-sort=mean

  analyze:
    # https://github.com/terryyin/lizard
    name: Analyze CCN number, AST
    runs-on: ubuntu-latest
    needs:
      - actionlint
    permissions:
      contents: read
    env:
      LIZARD_CCN_COUNT: 10
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python ${{ env.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.python-version }}
      - name: Restore cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
            %LOCALAPPDATA%\pypoetry\Cache
            %USERPROFILE%\.cache\pypoetry
          key: ${{ runner.os }}-python${{ env.python-version }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python${{ env.python-version }}-poetry
      - name: Bootstrap poetry
        run: |
          curl -sL https://install.python-poetry.org | python - -y
        shell: bash
      - name: Update PATH
        run: echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        shell: bash
      - name: Configure poetry
        run: poetry config virtualenvs.in-project false
        shell: bash
      - name: Install dependencies
        shell: bash
        run: |
          poetry install --no-interaction --no-root --only main,dev
      - name: Run lizard (analyze CCN for production codes)
        run: |
          poetry run lizard -x "./node_modules/*" -x "./.venv/*" -x "./build/*" -x "./dist/*" -x "./htmlcov/*" -x "./tests/*" --CCN "$LIZARD_CCN_COUNT"
      - name: Show AST (app.py)
        run: |
          python <<EOF
          import ast
          print(ast.dump(ast.parse(open("app.py").read()), indent=2))
          EOF
      - name: Show AST (features/*.py)
        run: |
          python <<EOF
          import ast
          import os
          import pprint

          target_dir = "./features"
          ast_trees = {}
          for file in os.listdir(target_dir):
              if file.endswith(".py"):
                  ast_trees[file] = ast.dump(ast.parse(open(os.path.join(target_dir, file)).read()), indent=2)

          pprint.pprint(ast_trees, width=100, compact=False)
          EOF

  build:
    name: Build desktop app
    strategy:
      matrix:
        os:
          - macos-latest
          - windows-latest
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.os == 'windows-latest' }}
    needs:
      - actionlint
    permissions:
      contents: read
    timeout-minutes: 5
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.node-version }}
      - name: Restore cache node-electron dependencies
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node${{ env.node-version }}-electron-deps-${{ hashFiles('**/package-lock.json') }}
      - name: Install stlite
        run: |
          npm install
      - name: Restore cache node-electron dependencies
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node${{ env.node-version }}-electron-deps-${{ hashFiles('**/package-lock.json') }}
      - name: Restore cache electron-builder (Windows)
        # https://github.com/electron/get#usage
        uses: actions/cache@v4
        with:
          path: |
            %LOCALAPPDATA%/electron/Cache
            ~/AppData/Local/electron/Cache/
          key: ${{ runner.os }}-node-electron-builder-${{ hashFiles('**/package-lock.json') }}
        if: ${{ runner.os == 'Windows' }}
      - name: Restore cache electron-builder (MacOS)
        # https://github.com/electron/get#usage
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/electron/
          key: ${{ runner.os }}-node-electron-builder-${{ hashFiles('**/package-lock.json') }}
        if: ${{ runner.os == 'MacOS' }}
      - name: Dump package
        run: |
          npm run dump
        # TODO: stliteのWindows環境のビルド失敗が解消したら削除
        if: ${{ runner.os == 'MacOS' }}
      - name: Build
        run: |
          npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # TODO: stliteのWindows環境のビルド失敗が解消したら削除
        if: ${{ runner.os == 'MacOS' }}
      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-build-artifact
          path: ./dist/*.exe
          retention-days: 3
          compression-level: 9
        if: ${{ runner.os == 'Windows' }}
      - name: Upload artifact (MacOS)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-build-artifact
          path: ./dist/*.dmg
          retention-days: 3
          compression-level: 9
        if: ${{ runner.os == 'MacOS' }}
